# Yardarm

![Build](https://github.com/CenterEdge/Yardarm/workflows/Build/badge.svg?branch=main&event=push)
[![NuGet](https://img.shields.io/nuget/dt/Yardarm?label=NuGet&logo=NuGet)](https://www.nuget.org/packages/Yardarm)
[![Join the chat at https://gitter.im/CenterEdgeYardarm/community](https://badges.gitter.im/CenterEdgeYardarm/community.svg)](https://gitter.im/CenterEdgeYardarm/community?utm_source=badge&utm_medium=badge&utm_campaign=pr-badge&utm_content=badge)

Yardarm is an OpenAPI 3 SDK Generator for C#. It provides various tools that will generate an SDK for a valid OpenAPI specification.

## Features

- Works with valid OpenAPI 3 specs, in JSON or YAML format
- Many generation options
  - Command Line Application
  - Docker Image
  - In-code via library
  - .NET Core Global Tool
- Generates a SDK using modern C# patterns and practices as follows:
  - Asynchronous methods with cancellation tokens
  - Nullable reference types
  - Interfaces with concrete implementations
    - Should support mocking the implementations for consumers to write unit tests
  - XML documentation for IntelliSense
  - Portable PDB
  - Dependency injection support via `Microsoft.Extensions.DependencyInjection.Abstractions`
- Fast SDK generation
  - Doesn't make C# files on disk and run MSBuild
  - Uses Roslyn to compile directly in memory
- Built-in NuGet support
  - Generate valid `.nupkg` files directly, with correct dependencies
  - Target multiple framework versions in one package automatically
  - Automatically restore packages required for compilation
- Highly extensible SDK generation
  - Built around plugable extensions that add additional features or modify the C# code used for compilation
  - Will include some out-of-the-box plugins for common scenarios
    - `Newtonsoft.Json` serialization/deserialization (done)
    - `System.Text.Json` serialization/deserialization (in progress)
    - `NodaTime` date/time properties
- Highly extensible SDK
  - Will allow the SDK consumer to extend the behaviors on the client side
  - Pluggable configuration for things like TLS and base urls
  - Add `HttpMessageHandler` instances to the `HttpClient` stack

## Consuming Yardarm SDKs

See [the detailed documentation](./docs/consuming) on consuming SDKs generated by Yardarm.

## Using Yardarm

### .NET Core Global Tool

```sh
dotnet tool install --global Yardarm.CommandLine --version 0.2.0-alpha001

yardarm help generate
```

### Docker

```sh
docker run -it ghcr.io/centeredge/yardarm:0.2.0-alpha001

yardarm help generate
```

### Example Commands

```sh
# Generate a DLL and related files, with Newtonsoft.Json support
yardarm generate -i my-spec.yaml -n MySpec -v 1.0.0 -o output/directory/ -x Yardarm.NewtonsoftJson

# Generate a NuGet package and symbols package, with Newtonsoft.Json support
yardarm generate -i my-spec.json -n MySpec -v 1.0.0 --nupkg output/directory/ -x Yardarm.NewtonsoftJson

# Generate a DLL and related files, with System.Text.Json support targeting net6.0
yardarm generate -i my-spec.yaml -n MySpec -v 1.0.0 -f net6.0 -o output/directory/ -x Yardarm.SystemTextJson

# Generate a NuGet package and symbols package, with System.Text.Json support targeting net6.0 and netstandard2.0
yardarm generate -i my-spec.json -n MySpec -v 1.0.0 -f net6.0 netstandard2.0 --nupkg output/directory/ -x Yardarm.SystemTextJson

# Note the trailing slash on the output directory. If there is no trailing slash, it is assumed to be a DLL or nupkg file name.
# Related files will be output beside that file.
```

## Source Code

Source code for the generated SDKs is created dynamically, in-memory and is never persisted
to disk. This is an intentional decision for performance. However, the source code itself
may be useful. Perhaps a decompiler would like to offer a better-formatted look at your
generated SDK. Or perhaps the SDK consumer would like to step through the SDK code in their
debugger.

This is supported using the `--embed` command line switch. When this switch is set, the generated
code will be formatted with standard whitespace and embedded in the PDB file with any symbols
output. If generating a NuGet package, they will be included in the `snupkg` file. This makes
the source code available to modern debuggers and decompilers.

Note: To debug into a generated SDK in Visual Studio, be sure to uncheck Just My Code in the
debugging options of Visual Studio.

## Reference assemblies

To improve build speed of SDK consumers, a reference assembly is created when:

1. `--ref file.dll` is passed to specify a specific location for a reference assembly.
2. `-o path/` is used to output to a directory. A `ref` subdirectory will be created for the reference assembly.
3. `--nupkg` is  used to create a NuGet package. A reference assembly will be embedded in the package for each target framework.

See [Reference Assemblies](https://docs.microsoft.com/en-us/dotnet/standard/assembly/reference-assemblies) for more
information.

## A note on System.Text.Json support

When using System.Text.Json, it is recommended that you target net6.0 at a minimum. Multi-targeting and including
netstandard2.0 in your NuGet package is fine, but standalone targeting of netstandard2.0 or netcoreapp3.1 have problems.

This is because there are some binary breaking changes between the netstandard2.0 and net6.0 of System.Text.Json.dll
published by Microsoft. The net6.0 version includes public init-only properties, while in netstandard2.0 they have
traditional setters. This means that a Yardarm SDK built against netstandard2.0 may fail if it is ever consumed by a
net6.0 application. Ensuring that you include a net6.0 target avoids this problem.

## Contributing

Please read [CONTRIBUTING.md](CONTRIBUTING.md) for details on our code of conduct, and the process for submitting pull requests to us.

## Authors

* **Brant Burnett** - *Initial work* - [BrantBurnett](https://github.com/brantburnett)

See also the list of [contributors](https://github.com/CenterEdge/Yardarm/graphs/contributors) who participated in this project.

## License

This project is licensed under the Apache 2.0 License - see the [LICENSE.md](LICENSE.md) file for details
